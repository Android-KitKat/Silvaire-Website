---
import { momentsData } from '../moment'

// 按年份分组
const groups = (() => {
  const grouped: Record<string, typeof momentsData> = {};
  momentsData.forEach(item => {
    const year = item.date.slice(0, 4)
    if (!grouped[year]) grouped[year] = []
    grouped[year].push(item)
  })
  // 转为数组并按年份倒序
  return Object.keys(grouped)
    .sort((a, b) => b.localeCompare(a))
    .map(year => ({
      year,
      moments: grouped[year].sort((a, b) =>
        (b.date + ' ' + (b.time ?? '00:00')).localeCompare(a.date + ' ' + (a.time ?? '00:00'))
      )
    }))
})()

function formatDate(dateStr: string) {
  const match = dateStr.match(/^\d{4}-(\d{2})-(\d{2})$/)
  if (match) {
    const [, month, day] = match
    return `${month}-${day}`
  }
  return dateStr
}
---

<div class="card-base px-8 py-6">
  {
    groups.map(group => (
      <div class="relative">
        <div class="absolute left-[22.5%] md:left-[15%] top-[2.3rem] bottom-4
                    border-[1px] border-solid border-[var(--line-color)]
                    pointer-events-none z-20">
        </div>

        <div class="flex flex-row w-full items-center h-[3.75rem]">
          <div class="w-[15%] md:w-[10%] transition text-2xl font-bold text-right text-75">
            {group.year}
          </div>

          <div class="w-[15%] md:w-[10%]">
            <div class="h-3 w-3 bg-none rounded-full outline outline-[var(--primary)] mx-auto -outline-offset-[2px] z-50 outline-3 relative left-[1px]"></div>
          </div>

          <div class="w-[70%] md:w-[80%] transition text-left text-50 relative left-2">
            {group.moments.length} 条动态
          </div>
        </div>

        {group.moments.map(item => (
          <div class="group btn-plain !block w-full rounded-lg hover:text-[initial] relative">
            <div class="flex flex-row justify-start items-center h-full">
              <div class="w-[15%] md:w-[10%] transition text-sm text-right text-50">
                {formatDate(item.date)}
              </div>

               <div class="w-[15%] md:w-[10%] relative h-full flex items-center">
                                <div class="transition-all mx-auto w-1 h-1 rounded group-hover:h-5 z-20
                                bg-[oklch(0.5_0.05_var(--hue))] group-hover:bg-[var(--primary)]
                                outline outline-4
                                outline-[var(--card-bg)]
                                group-hover:outline-[var(--btn-plain-bg-hover)]
                                group-active:outline-[var(--btn-plain-bg-active)]
                                relative right-[-1px] 
                                "
                                ></div>
                            </div>

              <div class="w-[70%] md:max-w-[65%] md:w-[65%] text-left font-bold group-hover:translate-x-1 transition-all group-hover:text-[var(--primary)] text-75 pr-8 p-2">
                {item.content}
              </div>

              <div class="hidden md:block md:w-[15%] text-left text-sm transition
                          whitespace-nowrap overflow-ellipsis overflow-hidden text-30">
                {item.time}
              </div>
            </div>
          </div>
        ))}
      </div>
    ))
  }
</div>